import { WhatsAppClient } from '../utils/whatsapp-client';
import { SessionService } from './session.service';
import { firebaseDb } from '../utils/firebase-db';
import { IncomingMessage, ConversationState } from '../types';
import { logger } from '../utils/logger';

export interface VendorData {
  ownerName?: string;
  businessName?: string;
  serviceCategories?: string[];
  serviceAreas?: string[];
}

export class VendorOnboardingService {
  private whatsapp = new WhatsAppClient();
  private sessionService = new SessionService();

  async handleVendorFlow(message: IncomingMessage, state: ConversationState): Promise<boolean> {
    // Start vendor onboarding
    if (message.buttonReply?.id === 'vendor_start') {
      state.step = 'VENDOR_NAME';
      await this.sessionService.setState(message.from, state);
      await this.whatsapp.sendText(
        message.from,
        `ğŸ‘‹ *Welcome Partner!*\n\nLet's get you registered in 5 simple steps.\n\nï¿½ï¿½ *Step 1/5*\nWhat's your full name?\n\nğŸ’¬ Example: Rajesh Kumar`
      );
      return true;
    }

    // Collect vendor name
    if (state.step === 'VENDOR_NAME') {
      state.vendorData = state.vendorData || {};
      state.vendorData.ownerName = message.text || '';
      state.step = 'VENDOR_BUSINESS';
      await this.sessionService.setState(message.from, state);
      await this.whatsapp.sendText(
        message.from,
        `âœ… Great, ${state.vendorData.ownerName}!\n\nğŸ“ *Step 2/5*\nWhat's your business name?\n\nğŸ’¬ Example: Kumar AC Services`
      );
      return true;
    }

    // Collect business name
    if (state.step === 'VENDOR_BUSINESS') {
      state.vendorData = state.vendorData || {};
      state.vendorData.businessName = message.text || '';
      state.step = 'VENDOR_SERVICES';
      await this.sessionService.setState(message.from, state);
      await this.whatsapp.sendList(
        message.from,
        `âœ… Perfect!\n\nğŸ“ *Step 3/5*\nWhich services do you provide?\n\nSelect your main service category:`,
        'ğŸ› ï¸ Choose Service',
        [
          {
            title: 'Available Services',
            rows: [
              { id: 'vendor_service_AC', title: 'â„ï¸ AC Service', description: 'Repair, installation, maintenance' },
              { id: 'vendor_service_CLEANING', title: 'ğŸ§¹ Cleaning', description: 'Home, office cleaning' },
              { id: 'vendor_service_PLUMBING', title: 'ğŸ”§ Plumbing', description: 'Pipes, leaks, installation' },
              { id: 'vendor_service_ELECTRICAL', title: 'âš¡ Electrical', description: 'Wiring, repair, install' },
              { id: 'vendor_service_PAINTING', title: 'ğŸ¨ Painting', description: 'Interior, exterior' },
              { id: 'vendor_service_CARPENTER', title: 'ğŸªš Carpentry', description: 'Furniture, doors' }
            ]
          }
        ]
      );
      return true;
    }

    // Collect services
    if (state.step === 'VENDOR_SERVICES') {
      state.vendorData = state.vendorData || {};
      const serviceId = message.listReply?.id?.replace('vendor_service_', '') || message.text?.toUpperCase() || 'AC';
      state.vendorData.serviceCategories = [serviceId];
      state.step = 'VENDOR_ADDRESS';
      await this.sessionService.setState(message.from, state);
      await this.whatsapp.sendText(
        message.from,
        `âœ… ${serviceId} selected!\n\nğŸ“ *Step 4/5*\nWhich areas do you serve?\n\nShare your service locations:\n\nğŸ’¬ Example:\nKarol Bagh, Delhi\nConnaught Place, Delhi\nJhansi, UP`
      );
      return true;
    }

    // Collect address/service areas
    if (state.step === 'VENDOR_ADDRESS') {
      state.vendorData = state.vendorData || {};
      state.vendorData.serviceAreas = message.text?.split('\n').map((a: string) => a.trim()) || ['Delhi NCR'];
      
      // Create vendor
      try {
        const vendor = await firebaseDb.createVendor({
          phoneNumber: message.from,
          ownerName: state.vendorData.ownerName || 'Unknown',
          businessName: state.vendorData.businessName || 'Unknown Business',
          serviceCategories: state.vendorData.serviceCategories || ['AC'],
          serviceAreas: state.vendorData.serviceAreas,
          isActive: true,
          rating: 4.5
        });

        await this.whatsapp.sendText(
          message.from,
          `ğŸ‰ *Congratulations ${state.vendorData.ownerName}!*\n\nâœ… You're now registered as:\n*${state.vendorData.businessName}*\n\nğŸ“‹ *Your Details:*\nğŸ› ï¸ Services: ${(state.vendorData.serviceCategories || []).join(', ')}\nğŸ“ Areas: ${(state.vendorData.serviceAreas || []).slice(0, 2).join(', ')}\nâ­ Rating: 4.5/5\n\nğŸ”¥ *Next Steps:*\nâ€¢ Our team will verify your profile (24 hrs)\nâ€¢ You'll start receiving customer leads\nâ€¢ Complete jobs to earn money\n\nğŸ’° Commission: 15% per booking\nğŸ“ Support: +91-9999663120\n\nVendor ID: ${vendor.id}`
        );

        // Reset state
        state.step = 'START';
        state.vendorData = undefined;
        await this.sessionService.setState(message.from, state);
      } catch (error) {
        logger.error(error, 'Error creating vendor');
        await this.whatsapp.sendText(
          message.from,
          `âŒ Sorry, there was an error registering you. Please try again or contact support at 1800-CITIMSTR`
        );
        state.step = 'START';
        await this.sessionService.setState(message.from, state);
      }
      return true;
    }

    return false;
  }
}
